"use strict";(()=>{var e={};e.id=757,e.ids=[757],e.modules={2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4300:e=>{e.exports=require("buffer")},2081:e=>{e.exports=require("child_process")},6113:e=>{e.exports=require("crypto")},2361:e=>{e.exports=require("events")},3685:e=>{e.exports=require("http")},5687:e=>{e.exports=require("https")},1808:e=>{e.exports=require("net")},4577:e=>{e.exports=require("punycode")},2781:e=>{e.exports=require("stream")},4404:e=>{e.exports=require("tls")},7310:e=>{e.exports=require("url")},3837:e=>{e.exports=require("util")},9796:e=>{e.exports=require("zlib")},9806:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>g,originalPathname:()=>x,patchFetch:()=>E,requestAsyncStorage:()=>h,routeModule:()=>b,serverHooks:()=>m,staticGenerationAsyncStorage:()=>_,staticGenerationBailout:()=>f});var s={};r.r(s),r.d(s,{POST:()=>d});var o=r(5489),i=r(8285),a=r(2377),n=r(9001),u=r(1985),c=r(1225),p=r(508);let l=process.env.STRIPE_WEBHOOK_SECRET;async function d(e){try{let t;let r=await e.text(),s=e.headers.get("stripe-signature");if(!s||!l)return console.error("Webhook signature or secret missing"),new c.Z("Webhook signature or secret missing",{status:400});try{t=p.Ag.webhooks.constructEvent(r,s,l)}catch(e){return console.error("Webhook signature verification failed:",e),new c.Z("Webhook signature verification failed",{status:400})}let o=(0,n.createRouteHandlerClient)({cookies:u.cookies});switch(t.type){case"customer.subscription.created":case"customer.subscription.updated":case"customer.subscription.deleted":{let e=t.data.object,r=e.customer;try{await o.from("profiles").update({subscription_status:e.status,subscription_id:e.id,current_period_end:new Date(1e3*e.current_period_end).toISOString()}).eq("stripe_customer_id",r)}catch(e){return console.error("Error updating subscription in database:",e),new c.Z("Error updating subscription",{status:500})}break}case"checkout.session.completed":{let e=t.data.object,r=e.customer,s=e.subscription;try{await o.from("profiles").update({stripe_customer_id:r,subscription_id:s,subscription_status:"active"}).eq("id",e.client_reference_id)}catch(e){return console.error("Error updating profile after checkout:",e),new c.Z("Error updating profile",{status:500})}break}case"invoice.payment_failed":{let e=t.data.object.customer;try{await o.from("profiles").update({subscription_status:"past_due"}).eq("stripe_customer_id",e)}catch(e){return console.error("Error updating subscription status:",e),new c.Z("Error updating subscription status",{status:500})}break}case"customer.subscription.trial_will_end":{let e=t.data.object,r=e.customer;try{await o.from("profiles").update({subscription_status:e.status}).eq("stripe_customer_id",r)}catch(e){return console.error("Error updating trial status:",e),new c.Z("Error updating trial status",{status:500})}break}default:console.log(`Unhandled event type: ${t.type}`)}return new c.Z(null,{status:200})}catch(e){return console.error("Webhook error:",e),new c.Z("Webhook Error",{status:400})}}let b=new o.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/stripe/webhook/route",pathname:"/api/stripe/webhook",filename:"route",bundlePath:"app/api/stripe/webhook/route"},resolvedPagePath:"/Users/refactortalent/TalentprimerAPP/career-path-pilot-app/apps/web/app/api/stripe/webhook/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:h,staticGenerationAsyncStorage:_,serverHooks:m,headerHooks:g,staticGenerationBailout:f}=b,x="/api/stripe/webhook/route";function E(){return(0,a.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:_})}},508:(e,t,r)=>{r.d(t,{Mc:()=>a,Pg:()=>n,Ag:()=>i});var s=r(8180);if(!process.env.STRIPE_SECRET_KEY)throw Error("Missing env.STRIPE_SECRET_KEY");let o=process.env.STRIPE_SECRET_KEY,i=new s.Z(o,{apiVersion:"2023-10-16",typescript:!0});async function a({customerId:e,priceId:t,successUrl:r,cancelUrl:s}){return i.checkout.sessions.create({customer:e,line_items:[{price:t,quantity:1}],mode:"subscription",success_url:r,cancel_url:s})}async function n({customerId:e,returnUrl:t}){return i.billingPortal.sessions.create({customer:e,return_url:t})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[705,281,602,180],()=>r(9806));module.exports=s})();